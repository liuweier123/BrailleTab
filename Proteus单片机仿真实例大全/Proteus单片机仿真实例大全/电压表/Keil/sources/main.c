//*************************************************************************************************
//*************************************************************************************************
//**<程序名>：数字电压表																 		 **
//**<功能>：使用LCD显示被检测电压，精度为0.05V，范围是0～5V。									 **
//**<版本说明>：这是第2版，使用LCD显示。														 **
//**<作者>：程沛																				 **
//**<完成时间>：2007年8月8日																	 **
//**<联系方式>：superyongzhe@163.com															 **
//*************************************************************************************************
//*************************************************************************************************

//*************************************************************************************************
//*																								  *
//*			 ******************************头文件及宏定义**************************				  *
//*																								  *
//*************************************************************************************************
#include "includes.h"

#define TIME0H 0x3C
#define TIME0L 0xB0



//*************************************************************************************************
//*																								  *
//*			  *******************************全局变量*****************************				  *
//*																								  *
//*************************************************************************************************
unsigned char uc_Clock=0;		//定时器0中断计数

bit b_DATransform=0;



//<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
//<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<把电压显示在LCD上>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
//<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
void vShowVoltage(unsigned int uiNumber)
{
	unsigned char ucaNumber[3],ucCount;

	if(uiNumber>999)					
		uiNumber=999;

	ucaNumber[0]=uiNumber/100;								//把计算数字的每个位存入数组。
	ucaNumber[1]=(uiNumber-100*(int)ucaNumber[0])/10;							
	ucaNumber[2]=uiNumber-100*(int)ucaNumber[0]-10*ucaNumber[1];

	for(ucCount=0;ucCount<3;ucCount++)
		{
		vShowOneChar(ucaNumber[ucCount]+48);				//从首位到末位逐一输出。
		if(ucCount==0)
			vShowOneChar('.');
		}

}

//*************************************************************************************************
//*																								  *
//*			  ********************************主函数******************************				  *
//*																								  *
//*************************************************************************************************
void main()
{

//<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<设置定时器0>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
	TMOD=0x01;			//定时器0，模式1。
	TH0=TIME0H;
	TL0=TIME0L;
	TR0=1;				//启动定时器。
	ET0=1;				//开定时器中断。

	EA=1;				//开总中断



	vdInitialize();

	vWriteCMD(0x84);	   //写入显示起始地址（第二行第一个位置）

	vShowChar("Voltage:");
	vWriteCMD(0xC9);
	vShowChar("(V)");


	while(1)
		{
		if(b_DATransform==1)
			{
			b_DATransform=0;
			vWriteCMD(0xC4);
			vShowVoltage(uiADTransform());
			}
		}
}

//<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
//<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<定时器0中断函数>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
//<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
void Time0() interrupt 1
{
	if(uc_Clock==0)
		{
		uc_Clock=5;
		b_DATransform=1;
		}
	else
		uc_Clock--;

	TH0=TIME0H;		   //恢复定时器0。
	TL0=TIME0L;
}


